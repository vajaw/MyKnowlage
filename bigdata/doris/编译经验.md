# doris 源码编译

## mac 使用 docker 构建源码环境
### 1、下载源码
```
git clone
```
### 2、下载master分支对应的镜像
```
docker pull apache/doris:build-env-ldb-toolchain-latest
```
### 3、启动容器
```
docker run -it \
-p 127.0.0.1:8040:8040 \
-p 127.0.0.1:8022:22 \
--privileged \
--name doris-docker \
-v ~/.m2:/root/.m2 \
-v /Users/wangjiang/Project/IdeaProjects/apache/doris:/root/doris \
apache/doris:build-env-ldb-toolchain-latest
```
### 4、编译
```
sh build --fe -j 8
sh build --fe -j 8
sh build-thirdparty.sh -j 8
```

### 5、容器内启动 ssh rsync 服务
```
yum install -y openssh-server openssh-clients rsync
passwd root
ssh-keygen -A
/usr/sbin/sshd -D &
```
### 6、构建 be 开发环境
注意：在执行以下步骤前需要先确定 mac 中下载完成 clion、docker desktop，并且上述操作已经执行完毕。
#### 6.1、配置 ToolChains
```
配置如何免密登录、以及cmake gcc g++ gdb在服务器上的地址
```
<img src= "/sources/png/img.png">

#### 6.2、配置 Cmake
```
在 cmake options 添加相关环境变量 （猜了个坑，在进行load project时，找不到 OpenMP，所以在这添加相关环境变量），具体参数如下：
-DDORIS_JAVA_HOME=/usr/lib/jvm/jdk-17.0.2 -DOpenMP_C_FLAGS="-fopenmp" -DOpenMP_CXX_FLAGS="-fopenmp" -DOpenMP_C_LIB_NAMES="gomp" -DOpenMP_CXX_LIB_NAMES="gomp" -DOpenMP_gomp_LIBRARY="/usr/lib64/libgomp.so.1.0.0"
```
<img src= "/sources/png/img_1.png">

#### 6.3、配置 Deployment Mappings
```
配置宿主机，容器源码目录映射
```
<img src= "/sources/png/img_2.png">

## 报错记录
### 1、在idea中 run fe 时idea编译报错
#### 报错内容
```
Executing pre-compile tasks…
Running 'before' tasks
Checking sources
Copying resources… [fe-common]
Copying resources… [fe-core.main]
Dependency analysis found 0 affected files
Updating dependency information… [fe-core.main]
Parsing java… [fe-core.main]
java: 编译器 (17.0.12) 中出现异常错误。如果在 Bug Database (https://bugs.java.com) 中没有找到该错误，请通过 Java Bug 报告页 (https://bugreport.java.com) 建立该 Java 编译器 Bug。请在报告中附上您的程序、以下诊断信息以及传递到 Java 编译器的参数。谢谢。
java: 	at jdk.compiler/com.sun.tools.javac.util.List.of(List.java:137)
java: 	at jdk.compiler/com.sun.tools.javac.util.ListBuffer.append(ListBuffer.java:129)
java: 	at jdk.compiler/com.sun.tools.javac.comp.MemberEnter.visitMethodDef(MemberEnter.java:210)
java: 	at jdk.compiler/com.sun.tools.javac.tree.JCTree$JCMethodDecl.accept(JCTree.java:921)
java: 	at jdk.compiler/com.sun.tools.javac.comp.MemberEnter.memberEnter(MemberEnter.java:163)
java: 	at jdk.compiler/com.sun.tools.javac.comp.MemberEnter.memberEnter(MemberEnter.java:175)
java: 	at jdk.compiler/com.sun.tools.javac.comp.TypeEnter$MembersPhase.finishClass(TypeEnter.java:1105)
java: 	at jdk.compiler/com.sun.tools.javac.comp.TypeEnter$MembersPhase.runPhase(TypeEnter.java:1049)
java: 	at jdk.compiler/com.sun.tools.javac.comp.TypeEnter$Phase.doCompleteEnvs(TypeEnter.java:288)
java: 	at jdk.compiler/com.sun.tools.javac.comp.TypeEnter$AbstractMembersPhase.doCompleteEnvs(TypeEnter.java:928)
java: 	at jdk.compiler/com.sun.tools.javac.comp.TypeEnter$Phase.completeEnvs(TypeEnter.java:257)
java: 	at jdk.compiler/com.sun.tools.javac.comp.TypeEnter$Phase.completeEnvs(TypeEnter.java:272)
java: 	at jdk.compiler/com.sun.tools.javac.comp.TypeEnter.complete(TypeEnter.java:204)
java: 	at jdk.compiler/com.sun.tools.javac.code.Symbol.complete(Symbol.java:682)
java: 	at jdk.compiler/com.sun.tools.javac.code.Symbol$ClassSymbol.complete(Symbol.java:1410)
java: 	at jdk.compiler/com.sun.tools.javac.comp.Enter.complete(Enter.java:610)
java: 	at jdk.compiler/com.sun.tools.javac.comp.Enter.main(Enter.java:587)
java: 	at jdk.compiler/com.sun.tools.javac.main.JavaCompiler.enterTrees(JavaCompiler.java:1042)
java: 	at jdk.compiler/com.sun.tools.javac.main.JavaCompiler.compile(JavaCompiler.java:917)
java: 	at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl.lambda$doCall$0(JavacTaskImpl.java:104)
java: 	at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl$$Lambda$415/0x000000011f3715b0.call(Unknown Source)
java: 	at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl.invocationHelper(JavacTaskImpl.java:152)
java: 	at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl.doCall(JavacTaskImpl.java:100)
java: 	at jdk.compiler/com.sun.tools.javac.api.JavacTaskImpl.call(JavacTaskImpl.java:94)
java: 	at org.jetbrains.jps.javac.JavacMain.compile(JavacMain.java:241)
java: 	at org.jetbrains.jps.incremental.java.JavaBuilder.lambda$compileJava$2(JavaBuilder.java:538)
java: 	at org.jetbrains.jps.incremental.java.JavaBuilder$$Lambda$375/0x000000011f32b9e8.invoke(Unknown Source)
java: 	at org.jetbrains.jps.incremental.java.JavaBuilder.invokeJavac(JavaBuilder.java:600)
Dependency analysis found 0 affected files
java: OutOfMemoryError: insufficient memory
Errors occurred while compiling module 'fe-core.main'
javac 17.0.12 was used to compile java sources
Finished, saving caches…
Builder Java requested build stop
Executing post-compile tasks…
Synchronizing output directories…
2025/9/5 21:46 - Build completed with 1 error and 0 warnings in 35 sec, 247 ms
```
#### 解决
<img src= "/sources/png/idea-javac-compile-fix.png">